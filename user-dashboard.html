<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Metrix HardLine ‚Äî User Dashboard</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-main: #0b0b0b;
    --bg-panel: #141414;
    --bg-card: #1b1b1b;
    --text-main: #ffffff;
    --text-muted: #b5b5b5;
    --accent: #401d65; /* login page color */
    --softy: #6c757d;
    --grind: #401d65; /* match login color */
    --hardline: #d32f2f;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-main);
    color: var(--text-main);
    overflow-x: hidden;
  }

  /* ===== TOP BAR ===== */
  header {
    height: 64px;
    background: var(--bg-panel);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    position: relative;
    z-index: 1200;
  }

  /* ‚úÖ NEW: header brand with logo */
  .brand {
    display:flex;
    align-items:center;
    gap:10px;
    min-width: 0;
  }
  .brand img {
    height: 28px;
    width: auto;
    display:block;
  }
  .brand h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.2rem;
    margin:0;
    white-space: nowrap;
  }
  @media (max-width: 480px){
    .brand img { height: 24px; }
    .brand h1 { font-size: 1.05rem; }
  }

  header button {
    background: var(--accent);
    color:white;
    border:none;
    padding:0.45rem 1rem;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }

  /* ‚úÖ NEW: Slide-down task action bar */
  .task-action-bar {
    position: fixed;
    top: 64px; /* under header */
    left: 0;
    right: 0;
    background: #111;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    transform: translateY(-120%);
    transition: transform 0.25s ease;
    z-index: 1100;
    padding: 0.75rem 1rem;
  }
  .task-action-bar.open { transform: translateY(0); }

  .task-action-row {
    max-width: 1400px;
    margin: auto;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
  }
  .task-action-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: white;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .task-action-meta {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
  }
  .task-action-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .task-action-btn {
    border: none;
    border-radius: 10px;
    padding: 0.55rem 0.75rem;
    font-weight: 800;
    cursor: pointer;
    color: white;
  }
  .task-action-btn.done { background: #2e7d32; }
  .task-action-btn.failed { background: #d32f2f; }
  .task-action-btn.close { background: var(--accent); }

  /* ===== MENU DRAWER ===== */
  .menu-drawer {
    position: fixed;
    top:0;
    right:-300px;
    width:300px;
    height:100%;
    background:#111;
    color:white;
    padding:1.5rem;
    transition: right 0.3s ease;
    z-index:1000;
    display:flex;
    flex-direction:column;
  }
  .menu-drawer.open { right:0; }
  .menu-drawer h2 { margin-top:0; }
  .menu-drawer button {
    margin-top:1rem;
    background: var(--accent);
    padding:.7rem;
    border:none;
    border-radius:8px;
    cursor:pointer;
    color:white;
    font-weight:bold;
  }

  /* ===== MAIN ===== */
  main { padding:1.5rem; max-width:1400px; margin:auto; }

  /* ===== STATS ===== */
  .stats {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap:1rem;
    margin-bottom:2rem;
  }
  .stat-card {
    background: var(--bg-card);
    border-radius:14px;
    padding:1.2rem;
    text-align:center;
    box-shadow:0 6px 16px rgba(0,0,0,0.3);
  }
  .stat-card h3 { margin:0; font-size:0.85rem; color:var(--text-muted); }
  .stat-card p { margin-top:0.4rem; font-size:1.6rem; font-weight:700; }

  /* ===== TASK CREATOR (STEP-BY-STEP) ===== */
  .task-form {
    background: var(--bg-card);
    border-radius:16px;
    padding:1.5rem;
    margin-bottom:2rem;
    max-width:520px;
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }
  .task-form h2 { font-family:'Space Grotesk',sans-serif; margin:0 0 1rem 0; }

  .task-step { display:none; flex-direction:column; gap:.6rem; margin-bottom:1rem; }
  .task-step.active { display:flex; }

  .task-form input, .task-form select {
    width:100%;
    padding:.7rem;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.08);
    background:#0f0f0f;
    color:white;
    font-weight:600;
  }

  .task-form button { width:100%; background: var(--accent); color:white; border:none; padding:.75rem; border-radius:10px; font-weight:700; cursor:pointer; }

  /* ===== CALENDAR ===== */
  .calendar-controls { display:flex; justify-content:space-between; margin-bottom:.5rem; max-width:1100px; }
  .calendar-controls button { background: var(--accent); border:none; color:white; padding:.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; }

  .calendar-wrapper { overflow-x:auto; padding-bottom:1rem; }
  .calendar {
    display:grid;
    grid-template-columns: repeat(7,minmax(160px,1fr));
    gap:10px;
    min-width:1100px;
  }
  .day {
    background: var(--bg-card);
    border-radius:14px;
    padding:.6rem;
    min-height:140px;
    position:relative;
  }
  .day-header { font-size:.75rem; color:var(--text-muted); margin-bottom:.4rem; }

  .task {
    padding:.35rem .6rem;
    border-radius:8px;
    font-size:.75rem;
    font-weight:700;
    margin-bottom:.3rem;
    cursor:pointer;
  }
  .Softy { background: var(--softy); }
  .GrindMode { background: var(--grind); }
  .HardLine { background: var(--hardline); }

  /* ‚úÖ NEW: task status colors */
  .task.done { background: #2e7d32 !important; }
  .task.failed { background: #d32f2f !important; }

  .tooltip {
    position: fixed;
    top: 10px;
    left: 10px;
    background: #0b0b0b;
    color: white;
    padding: .6rem;
    border-radius: 8px;
    font-size: .85rem;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    max-width: 250px;
  }

  .day.overdue { border: 2px solid red; }

  /* ===== COACH MESSAGING SYSTEM - NEW STYLES ===== */

  .coach-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: var(--bg-panel);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 999;
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .coach-panel-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .coach-panel-header h3 {
    margin: 0;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
  }

  .coach-panel-toggle {
    background: var(--accent);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .coach-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .coach-message {
    background: var(--bg-card);
    padding: 0.8rem;
    border-radius: 10px;
    border-left: 3px solid;
  }

  .coach-message.level-low { border-left-color: #4caf50; }
  .coach-message.level-medium { border-left-color: #ff9800; }
  .coach-message.level-high { border-left-color: #ff5722; }
  .coach-message.level-extreme { border-left-color: #d32f2f; }

  .coach-message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.4rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .coach-message-body {
    font-size: 0.85rem;
    line-height: 1.4;
  }

  .coach-message-task {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.4rem;
    font-style: italic;
  }

  .coach-popup {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 320px;
    background: linear-gradient(135deg, #1b1b1b 0%, #2a2a2a 100%);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    z-index: 1001;
    animation: slideIn 0.3s ease;
    border-left: 4px solid;
  }

  .coach-popup.level-low { border-left-color: #4caf50; }
  .coach-popup.level-medium { border-left-color: #ff9800; }
  .coach-popup.level-high { border-left-color: #ff5722; }
  .coach-popup.level-extreme { border-left-color: #d32f2f; }

  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .coach-popup-header {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .coach-popup-body {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }

  .coach-popup-task {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-style: italic;
  }

  .coach-mobile-alert {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #401d65 0%, #6a3a8f 100%);
    padding: 0.8rem 1rem;
    z-index: 998;
    animation: slideDown 0.4s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .coach-mobile-alert-content {
    max-width: 1400px;
    margin: auto;
    font-size: 0.85rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .coach-mobile-alert-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
  }

  @media (max-width: 768px) {
    .coach-panel {
      width: calc(100% - 40px);
      left: 20px;
      right: 20px;
      max-height: 400px;
    }

    .coach-popup {
      width: calc(100% - 40px);
      left: 20px;
      right: 20px;
    }
  }
</style>
</head>

<body>

<header>
  <!-- ‚úÖ UPDATED: logo added -->
  <div class="brand">
    <img src="/icons/Metrix.png" alt="Metrix HardLine" />
    <h1>Metrix HardLine</h1>
  </div>
  <button id="menuBtn">Menu</button>
</header>

<!-- ‚úÖ NEW: slide-down task action bar -->
<div class="task-action-bar" id="taskActionBar">
  <div class="task-action-row">
    <div class="task-action-title" id="taskActionTitle">Task</div>
    <div class="task-action-meta" id="taskActionMeta">Due:</div>
    <div class="task-action-buttons">
      <button class="task-action-btn done" id="taskDoneBtn">Task Done</button>
      <button class="task-action-btn failed" id="taskFailedBtn">I Failed</button>
      <button class="task-action-btn close" id="taskCloseBtn">Close</button>
    </div>
  </div>
</div>

<div class="menu-drawer" id="menuDrawer">
  <h2>Menu</h2>
  <p><strong>Username:</strong> user01</p>
  <p><strong>Email:</strong> <span id="menuEmail">user01@email.com</span></p>
  <button id="closeMenu">Close Menu</button>
  <button id="drawerLogout">Logout</button>
</div>

<main>

  <section class="stats">
    <div class="stat-card"><h3>Total Tasks</h3><p id="totalTasks">0</p></div>
    <div class="stat-card"><h3>Completed</h3><p id="completedTasks">0</p></div>
    <div class="stat-card"><h3>Missed</h3><p id="missedTasks">0</p></div>
  </section>

  <section class="task-form">
    <h2>Create Task</h2>
    <div class="task-step step1 active">
      <input id="taskTitle" placeholder="Task title" />
      <button id="step1Next">Next ‚Üí</button>
    </div>
    <div class="task-step step2">
      <input id="taskDeadline" type="date"/>
      <button id="step2Next">Next ‚Üí</button>
    </div>
    <div class="task-step step3">
      <select id="taskIntensity">
        <option value="Softy">Softy</option>
        <option value="GrindMode">GrindMode</option>
        <option value="HardLine">HardLine</option>
      </select>
      <button id="addTaskBtn">Add Task</button>
    </div>
  </section>

  <div class="calendar-controls">
    <button id="prevMonth">‚Üê Prev</button>
    <button id="nextMonth">Next ‚Üí</button>
  </div>

  <div class="calendar-wrapper">
    <section class="calendar" id="calendar"></section>
  </div>

</main>

<div class="tooltip" id="tooltip"></div>

<div class="coach-panel" id="coachPanel">
  <div class="coach-panel-header">
    <h3>üéØ Your Coach</h3>
    <button class="coach-panel-toggle" id="coachPanelToggle">Minimize</button>
  </div>
  <div class="coach-messages" id="coachMessages"></div>
</div>

<script>
  // ==================== MENU LOGIC ====================
  const menuBtn = document.getElementById('menuBtn');
  const menuDrawer = document.getElementById('menuDrawer');
  const closeMenu = document.getElementById('closeMenu');
  const drawerLogout = document.getElementById('drawerLogout');

  menuBtn.onclick = ()=> menuDrawer.classList.add('open');
  closeMenu.onclick = ()=> menuDrawer.classList.remove('open');
  drawerLogout.onclick = ()=> window.logout();

  // ==================== TASK CREATION STEP-BY-STEP ====================
  const step1 = document.querySelector('.step1');
  const step2 = document.querySelector('.step2');
  const step3 = document.querySelector('.step3');
  const step1Next = document.getElementById('step1Next');
  const step2Next = document.getElementById('step2Next');
  const addTaskBtn = document.getElementById('addTaskBtn');

  let tasks = window.tasks = [];

  step1Next.onclick = ()=> {
    if(!document.getElementById('taskTitle').value) return alert("Enter task title");
    step1.classList.remove('active'); step2.classList.add('active');
  };
  step2Next.onclick = ()=> {
    if(!document.getElementById('taskDeadline').value) return alert("Select date");
    step2.classList.remove('active'); step3.classList.add('active');
  };
  addTaskBtn.onclick = ()=> {
    const title = document.getElementById('taskTitle').value;
    const deadline = document.getElementById('taskDeadline').value;
    const intensity = document.getElementById('taskIntensity').value;
    if(!title||!deadline) return;

    const newTask = {
      title,
      deadline,
      intensity,
      completed:false,
      failed:false,
      status:"open",
      id: Date.now().toString()
    };
    tasks.push(newTask);
    if (window._saveTask) window._saveTask(newTask);

    step3.classList.remove('active'); step1.classList.add('active');
    document.getElementById('taskTitle').value='';
    document.getElementById('taskDeadline').value='';
    renderCalendar();
    updateStats();
    showNotifications();
    evaluateCoachMessages();
    checkOverdueCompletionPrompts();
  };

  // ==================== TASK ACTION BAR (NEW) ====================
  let selectedTaskId = null;

  const taskActionBar = document.getElementById("taskActionBar");
  const taskActionTitle = document.getElementById("taskActionTitle");
  const taskActionMeta = document.getElementById("taskActionMeta");
  const taskDoneBtn = document.getElementById("taskDoneBtn");
  const taskFailedBtn = document.getElementById("taskFailedBtn");
  const taskCloseBtn = document.getElementById("taskCloseBtn");

  function openTaskBar(task) {
    selectedTaskId = task.id;
    taskActionTitle.textContent = task.title || "Task";
    taskActionMeta.textContent = `Due: ${task.deadline || ""}`;
    taskActionBar.classList.add("open");

    if (window._maybeInitPushFromGesture) window._maybeInitPushFromGesture();
  }

  function closeTaskBar() {
    selectedTaskId = null;
    taskActionBar.classList.remove("open");
  }

  taskCloseBtn.onclick = closeTaskBar;

  function applyTaskStatus(status) {
    if (!selectedTaskId) return;
    const t = tasks.find(x => x.id === selectedTaskId);
    if (!t) return;

    if (status === "done") {
      t.completed = true;
      t.failed = false;
      t.status = "done";
    } else if (status === "failed") {
      t.failed = true;
      t.completed = false;
      t.status = "failed";
    }

    if (window._updateTaskFields) {
      window._updateTaskFields(t.id, { completed: t.completed, failed: !!t.failed, status: t.status });
    } else if (window._setTaskCompleted) {
      window._setTaskCompleted(t.id, t.completed);
    }

    updateStats();
    renderCalendar();
    showNotifications();
    evaluateCoachMessages();
    closeTaskBar();
  }

  taskDoneBtn.onclick = () => applyTaskStatus("done");
  taskFailedBtn.onclick = () => applyTaskStatus("failed");

  // ==================== CALENDAR LOGIC ====================
  const calendar = document.getElementById('calendar');
  let currentMonth = new Date();

  document.getElementById('prevMonth').onclick = ()=> {
    currentMonth.setMonth(currentMonth.getMonth()-1);
    renderCalendar();
  };
  document.getElementById('nextMonth').onclick = ()=> {
    currentMonth.setMonth(currentMonth.getMonth()+1);
    renderCalendar();
  };

  function checkOverdueCompletionPrompts() {
    const todayStr = new Date().toISOString().split('T')[0];

    const promptedKey = "metrix_overdue_prompted";
    const prompted = JSON.parse(localStorage.getItem(promptedKey) || "{}");

    tasks.forEach((t) => {
      if (t.completed || t.failed) return;
      if (!t.deadline) return;
      if (t.deadline >= todayStr) return;

      const k = `${t.id}_${todayStr}`;
      if (prompted[k]) return;

      prompted[k] = true;
      localStorage.setItem(promptedKey, JSON.stringify(prompted));

      const msg =
        `Task past due:\n\n"${t.title}"\nDue: ${t.deadline}\n\nDid you complete this task?\n\nOK = Task Done\nCancel = I Failed`;

      const didComplete = window.confirm(msg);

      if (didComplete) {
        t.completed = true; t.failed = false; t.status = "done";
        if (window._updateTaskFields) window._updateTaskFields(t.id, { completed: true, failed: false, status: "done" });
        else if (window._setTaskCompleted) window._setTaskCompleted(t.id, true);
      } else {
        t.failed = true; t.completed = false; t.status = "failed";
        if (window._updateTaskFields) window._updateTaskFields(t.id, { completed: false, failed: true, status: "failed" });
        else if (window._setTaskCompleted) window._setTaskCompleted(t.id, false);
      }

      updateStats();
      renderCalendar();
      showNotifications();
      evaluateCoachMessages();
    });
  }

  window.checkOverdueCompletionPrompts = checkOverdueCompletionPrompts;

  function renderCalendar(){
    calendar.innerHTML='';
    const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
    const todayStr = new Date().toISOString().split('T')[0];

    for(let d=start.getDate(); d<=end.getDate(); d++){
      const dayDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d);
      const dateStr = dayDate.toISOString().split('T')[0];

      const day = document.createElement('div'); day.className='day';
      if(dateStr < todayStr) day.classList.add('overdue');

      day.innerHTML=`<div class="day-header">${dateStr}</div>`;

      tasks.filter(t=>t.deadline===dateStr).forEach(t=>{
        const tEl=document.createElement('div');

        const statusClass = t.failed ? " failed" : (t.completed ? " done" : "");
        tEl.className = `task ${t.intensity}${statusClass}`;
        tEl.textContent = t.title;

        tEl.onclick = ()=> openTaskBar(t);

        day.appendChild(tEl);
      });

      calendar.appendChild(day);
    }
  }

  function updateStats(){
    document.getElementById('totalTasks').textContent=tasks.length;
    document.getElementById('completedTasks').textContent=tasks.filter(t=>t.completed).length;
    document.getElementById('missedTasks').textContent=tasks.filter(t=>!t.completed && !t.failed).length;
  }

  const tooltip = document.getElementById('tooltip');

  function showTooltip(message, duration=3000){
    tooltip.textContent = message;
    tooltip.style.display='block';
    setTimeout(()=>{ tooltip.style.display='none'; }, duration);
  }

  function showNotifications(){
    const todayStr = new Date().toISOString().split('T')[0];
    tasks.forEach(t=>{
      if((t.completed || t.failed)) return;
      if(t.deadline < todayStr){
        showTooltip(`‚è∞ Overdue: ${t.title}`);
      } else if(t.deadline === todayStr){
        showTooltip(`‚ö†Ô∏è Due Today: ${t.title}`);
      }
    });
  }

  renderCalendar();
  checkOverdueCompletionPrompts();

  const coachPanel = document.getElementById('coachPanel');
  const coachPanelToggle = document.getElementById('coachPanelToggle');
  let coachPanelMinimized = false;

  coachPanelToggle.onclick = ()=> {
    coachPanelMinimized = !coachPanelMinimized;
    if(coachPanelMinimized) {
      coachPanel.style.maxHeight = '60px';
      coachPanelToggle.textContent = 'Expand';
      document.getElementById('coachMessages').style.display = 'none';
    } else {
      coachPanel.style.maxHeight = '500px';
      coachPanelToggle.textContent = 'Minimize';
      document.getElementById('coachMessages').style.display = 'flex';
    }
  };

  const COACH_PHRASES = {
    low: [
      "Hey there! Just a gentle reminder about {task}. You've got this!",
      "Thinking about {task}? Now's a great time to make some progress.",
      "Small steps count! Consider tackling {task} today."
    ],
    medium: [
      "Time to focus! {task} needs your attention today.",
      "Let's get serious about {task}. Deadline is approaching."
    ],
    high: [
      "URGENT: {task} requires immediate action. No more waiting!",
      "Zero excuses. {task} must be completed today. Period."
    ],
    extreme: [
      "CODE RED: {task} is OVERDUE. This is your LAST chance!",
      "DEFCON 1: {task} cannot wait ONE MORE SECOND. MOVE!"
    ]
  };

  function getCoachStorageKey() { return 'metrix_coach_messages'; }
  function getStoredCoachMessages() {
    const stored = localStorage.getItem(getCoachStorageKey());
    return stored ? JSON.parse(stored) : [];
  }
  function saveCoachMessages(messages) {
    localStorage.setItem(getCoachStorageKey(), JSON.stringify(messages));
  }

  function getRandomPhrase(level, taskTitle) {
    const phrases = COACH_PHRASES[level] || COACH_PHRASES.low;
    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
    return randomPhrase.replace('{task}', taskTitle);
  }

  function getUrgencyLevel(daysUntilDeadline) {
    if (daysUntilDeadline < 0) {
      const daysOverdue = Math.abs(daysUntilDeadline);
      if (daysOverdue >= 3) return 'extreme';
      if (daysOverdue >= 1) return 'high';
      return 'medium';
    } else if (daysUntilDeadline === 0) {
      return 'high';
    } else if (daysUntilDeadline >= 7) {
      return 'low';
    } else {
      return 'medium';
    }
  }

  function getDaysUntilDeadline(deadlineStr) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const deadline = new Date(deadlineStr);
    deadline.setHours(0, 0, 0, 0);
    const diffTime = deadline - today;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  }

  function getMessageCountToday(taskId) {
    const messages = getStoredCoachMessages();
    const today = new Date().toISOString().split('T')[0];
    return messages.filter(m => m.taskId === taskId && m.date === today).length;
  }

  function sendCoachPanelMessage(task, level, message) {
    const messagesContainer = document.getElementById('coachMessages');
    const messageEl = document.createElement('div');
    messageEl.className = `coach-message level-${level}`;
    messageEl.innerHTML = `
      <div class="coach-message-header">
        <span>üéØ Coach</span>
        <span>${new Date().toLocaleTimeString()}</span>
      </div>
      <div class="coach-message-body">${message}</div>
      <div class="coach-message-task">Re: ${task.title}</div>
    `;
    messagesContainer.appendChild(messageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    const storedMessages = getStoredCoachMessages();
    const payload = {
      taskId: task.id,
      type: 'panel',
      level: level,
      message: message,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      read: false
    };
    storedMessages.push(payload);
    saveCoachMessages(storedMessages);

    if (window._persistCoachMessage) {
      window._persistCoachMessage({ ...payload, taskTitle: task.title });
    }

    if (window._queuePushCoach) {
      window._queuePushCoach({
        title: "Metrix Coach",
        body: message
      });
    }
  }

  function evaluateCoachMessages() {
    tasks.forEach(task => {
      if (task.completed || task.failed) return;

      const daysUntilDeadline = getDaysUntilDeadline(task.deadline);
      const level = getUrgencyLevel(daysUntilDeadline);

      let maxMessagesPerDay = 4;
      if (daysUntilDeadline < 0) {
        const daysOverdue = Math.abs(daysUntilDeadline);
        if (daysOverdue >= 3) maxMessagesPerDay = 10;
        else if (daysOverdue >= 1) maxMessagesPerDay = 6;
        else maxMessagesPerDay = 4;
      } else if (daysUntilDeadline === 0) {
        maxMessagesPerDay = 6;
      } else if (daysUntilDeadline <= 6) {
        maxMessagesPerDay = 5;
      }

      const messageCountToday = getMessageCountToday(task.id);

      if (messageCountToday < maxMessagesPerDay) {
        const message = getRandomPhrase(level, task.title);
        sendCoachPanelMessage(task, level, message);
      }
    });
  }

  evaluateCoachMessages();
  setInterval(() => { evaluateCoachMessages(); }, 60 * 60 * 1000);
</script>

<!-- ‚úÖ FIREBASE AUTH + FIRESTORE + FCM TOKEN SAVE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    updateDoc,
    getDoc,
    getDocs,
    query,
    orderBy,
    limit,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ‚úÖ FCM (push notifications)
  import {
    getMessaging,
    getToken,
    onMessage
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBqQF1Tijz_wctD0Z7kSCB80DeiWY1ZPyw",
    authDomain: "metrix-hardline.firebaseapp.com",
    projectId: "metrix-hardline",
    storageBucket: "metrix-hardline.firebasestorage.app",
    messagingSenderId: "899994703104",
    appId: "1:899994703104:web:2979fe39d1c3c169ee4fe5"
  };

  const FCM_VAPID_KEY = "BEH0GI6sTAl39BH8VaKsBQuoit6skekTlIOa2AZfmRc7JK56onlsx_PjhdjRSxM3qb2LMf0hHpF6iDrY9LJpnYU";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const messaging = getMessaging(app);

  // ‚úÖ NEW: Subscription gate helper (ONLY ADDITION)
  async function enforceSubscriptionGate(uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : null;

    const active = data?.subscriptionActive === true;

    if (!active) {
      try { await signOut(auth); } catch {}
      localStorage.removeItem("uid");
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  async function loadTasks(uid) {
    const snap = await getDocs(collection(db, "users", uid, "tasks"));
    const loaded = [];
    snap.forEach(d => loaded.push(d.data()));

    loaded.forEach(t => {
      if (typeof t.failed === "undefined") t.failed = false;
      if (typeof t.status === "undefined") t.status = t.completed ? "done" : "open";
    });

    window.tasks.length = 0;
    loaded.forEach(t => window.tasks.push(t));
  }

  async function saveTask(uid, task) {
    await setDoc(doc(db, "users", uid, "tasks", task.id), task, { merge: true });
  }

  async function setTaskCompleted(uid, taskId, completed) {
    await updateDoc(doc(db, "users", uid, "tasks", taskId), { completed });
  }

  async function updateTaskFields(uid, taskId, updates) {
    await updateDoc(doc(db, "users", uid, "tasks", taskId), updates);
  }

  window._saveTask = (task) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return saveTask(uid, task);
  };

  window._setTaskCompleted = (taskId, completed) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return setTaskCompleted(uid, taskId, completed);
  };

  window._updateTaskFields = (taskId, updates) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return updateTaskFields(uid, taskId, updates);
  };

  async function loadCoachMessages(uid) {
    const q = query(
      collection(db, "users", uid, "coachMessages"),
      orderBy("timestamp"),
      limit(200)
    );
    const snap = await getDocs(q);
    const msgs = [];
    snap.forEach(d => msgs.push(d.data()));

    localStorage.setItem("metrix_coach_messages", JSON.stringify(msgs));

    const container = document.getElementById("coachMessages");
    if (container) {
      container.innerHTML = "";
      msgs.forEach(m => {
        if (m.type !== "panel") return;
        const messageEl = document.createElement('div');
        messageEl.className = `coach-message level-${m.level}`;
        messageEl.innerHTML = `
          <div class="coach-message-header">
            <span>üéØ Coach</span>
            <span>${new Date(m.timestamp || Date.now()).toLocaleTimeString()}</span>
          </div>
          <div class="coach-message-body">${m.message}</div>
          <div class="coach-message-task">Re: ${m.taskTitle || ""}</div>
        `;
        container.appendChild(messageEl);
      });
      container.scrollTop = container.scrollHeight;
    }
  }

  async function persistCoachMessage(uid, msg) {
    await addDoc(collection(db, "users", uid, "coachMessages"), {
      ...msg,
      createdAt: serverTimestamp()
    });
  }

  window._persistCoachMessage = (msg) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    persistCoachMessage(uid, msg).catch(() => {});
  };

  async function saveFcmToken(uid, token) {
    await setDoc(doc(db, "users", uid, "fcmTokens", token), {
      token,
      platform: navigator.userAgent || "",
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  let didInitPush = false;

  async function initPushWithUserGesture() {
    if (didInitPush) return;
    didInitPush = true;

    try {
      if (!("Notification" in window)) return;

      if (Notification.permission === "default") {
        const perm = await Notification.requestPermission();
        if (perm !== "granted") return;
      }
      if (Notification.permission !== "granted") return;

      const swReg = await navigator.serviceWorker.register("/sw.js");

      const token = await getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: swReg
      });

      if (!token) return;

      const uid = localStorage.getItem("uid");
      if (!uid) return;

      await saveFcmToken(uid, token);
    } catch (e) {
      console.log("Push init error:", e);
    }
  }

  window._maybeInitPushFromGesture = initPushWithUserGesture;

  onMessage(messaging, (payload) => {
    try {
      if (Notification.permission === "granted" && payload?.notification?.body) {
        new Notification(payload.notification.title || "Metrix Coach", {
          body: payload.notification.body
        });
      }
    } catch {}
  });

  window._queuePushCoach = async ({ title, body }) => {
    try {
      const user = auth.currentUser;
      if (!user) return;

      const idToken = await user.getIdToken();

      await fetch("/api/send-push", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${idToken}`
        },
        body: JSON.stringify({
          title: title || "Metrix Coach",
          body: body || "",
          url: "/user-dashboard.html"
        })
      });
    } catch {}
  };

  window.logout = function () {
    signOut(auth).finally(() => {
      localStorage.removeItem("uid");
      window.location.href = "login.html";
    });
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    localStorage.setItem("uid", user.uid);

    // ‚úÖ NEW: subscription gate enforced BEFORE loading dashboard data
    const ok = await enforceSubscriptionGate(user.uid);
    if (!ok) return;

    const emailEl = document.getElementById("menuEmail");
    if (emailEl) emailEl.textContent = user.email || "";

    await loadTasks(user.uid);
    await loadCoachMessages(user.uid);

    if (typeof window.renderCalendar === "function") window.renderCalendar();
    if (typeof window.updateStats === "function") window.updateStats();
    if (window.checkOverdueCompletionPrompts) window.checkOverdueCompletionPrompts();
  });
</script>

</body>
</html>
