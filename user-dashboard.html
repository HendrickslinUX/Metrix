<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Metrix HardLine ‚Äî User Dashboard</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-main: #0b0b0b;
    --bg-panel: #141414;
    --bg-card: #1b1b1b;
    --text-main: #ffffff;
    --text-muted: #b5b5b5;
    --accent: #401d65;
    --softy: #6c757d;
    --grind: #401d65;
    --hardline: #d32f2f;
    --success: #2e7d32;
  }

  body.light-mode {
    --bg-main: #f3f4f6;
    --bg-panel: #ffffff;
    --bg-card: #ffffff;
    --text-main: #1c1c1c;
    --text-muted: #60656d;
    --softy: #adb5bd;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-main);
    color: var(--text-main);
    overflow-x: hidden;
    transition: background 0.2s ease, color 0.2s ease;
  }

  header {
    height: 64px;
    background: var(--bg-panel);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    position: relative;
    z-index: 1200;
  }

  .brand {
    display:flex;
    align-items:center;
    gap:10px;
    min-width: 0;
  }
  .brand img {
    height: 28px;
    width: auto;
    display:block;
  }
  .brand h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.2rem;
    margin:0;
    white-space: nowrap;
  }
  @media (max-width: 480px){
    .brand img { height: 24px; }
    .brand h1 { font-size: 1.05rem; }
  }

  header button {
    background: var(--accent);
    color:white;
    border:none;
    padding:0.45rem 1rem;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }

  .task-action-bar {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    background: #111;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    transform: translateY(-120%);
    transition: transform 0.25s ease;
    z-index: 1100;
    padding: 0.75rem 1rem;
  }
  .task-action-bar.open { transform: translateY(0); }

  .task-action-row {
    max-width: 1400px;
    margin: auto;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
  }
  .task-action-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: white;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .task-action-meta {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
  }
  .task-action-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  .task-action-btn {
    border: none;
    border-radius: 10px;
    padding: 0.55rem 0.75rem;
    font-weight: 800;
    cursor: pointer;
    color: white;
  }
  .task-action-btn.done { background: #2e7d32; }
  .task-action-btn.failed { background: #d32f2f; }
  .task-action-btn.close { background: var(--accent); }

  .menu-drawer {
    position: fixed;
    top:0;
    right:-300px;
    width:300px;
    height:100%;
    background:#111;
    color:white;
    padding:1.5rem;
    transition: right 0.3s ease;
    z-index:1000;
    display:flex;
    flex-direction:column;
  }
  .menu-drawer.open { right:0; }
  .menu-drawer h2 { margin-top:0; }
  .menu-drawer button {
    margin-top:1rem;
    background: var(--accent);
    padding:.7rem;
    border:none;
    border-radius:8px;
    cursor:pointer;
    color:white;
    font-weight:bold;
  }

  main { padding:1.5rem; max-width:1400px; margin:auto; }

  .stats {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap:1rem;
    margin-bottom:1rem;
  }
  .stat-card {
    background: var(--bg-card);
    border-radius:14px;
    padding:1.2rem;
    text-align:center;
    box-shadow:0 6px 16px rgba(0,0,0,0.3);
  }
  .stat-card h3 { margin:0; font-size:0.85rem; color:var(--text-muted); }
  .stat-card p { margin-top:0.4rem; font-size:1.6rem; font-weight:700; }

  .header-actions { display:flex; gap:.6rem; align-items:center; }
  .icon-btn { background: transparent; border:1px solid rgba(255,255,255,.14); color:var(--text-main); padding:.45rem .65rem; border-radius:10px; cursor:pointer; }

  .kpi-row { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:1rem; }
  .kpi-card { background: var(--bg-card); border-radius:14px; padding:1rem; }
  .kpi-card h3 { margin:0 0 .35rem 0; font-size:.9rem; color:var(--text-muted); }
  .kpi-value { font-size:1.5rem; font-weight:700; }
  .discipline-bar { height:8px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden; margin-top:.4rem; }
  .discipline-fill { height:100%; background:linear-gradient(90deg,#ff9800,#2e7d32); width:0%; }

  .filters { display:flex; gap:.7rem; margin-bottom:1rem; flex-wrap:wrap; }
  .filters select { background:var(--bg-card); color:var(--text-main); border:1px solid rgba(255,255,255,.12); border-radius:8px; padding:.55rem .7rem; }

  .analytics-panel, .weekly-panel { background:var(--bg-card); border-radius:14px; padding:1rem; margin-bottom:1rem; }
  .analytics-canvas { width:100%; height:180px; background:rgba(255,255,255,.03); border-radius:10px; }

  .toast-stack { position:fixed; top:80px; right:20px; display:flex; flex-direction:column; gap:.6rem; z-index:2200; }
  .toast { background:var(--bg-panel); border-left:4px solid var(--accent); padding:.65rem .75rem; border-radius:8px; font-size:.85rem; box-shadow:0 8px 24px rgba(0,0,0,.2); }

  .task-form {
    background: var(--bg-card);
    border-radius:16px;
    padding:1.5rem;
    margin-bottom:1rem;
    max-width:520px;
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }
  .task-form h2 { font-family:'Space Grotesk',sans-serif; margin:0 0 1rem 0; }

  .task-step { display:none; flex-direction:column; gap:.6rem; margin-bottom:1rem; }
  .task-step.active { display:flex; }

  .task-form input, .task-form select {
    width:100%;
    padding:.7rem;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.08);
    background:#0f0f0f;
    color:white;
    font-weight:600;
  }
  body.light-mode .task-form input, body.light-mode .task-form select { background:#f3f4f6; color:#1c1c1c; }

  .task-form button { width:100%; background: var(--accent); color:white; border:none; padding:.75rem; border-radius:10px; font-weight:700; cursor:pointer; }

  .calendar-controls { display:flex; justify-content:space-between; margin-bottom:.5rem; max-width:1100px; }
  .calendar-controls button { background: var(--accent); border:none; color:white; padding:.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; }

  .calendar-wrapper { overflow-x:auto; padding-bottom:1rem; }
  .calendar {
    display:grid;
    grid-template-columns: repeat(7,minmax(160px,1fr));
    gap:10px;
    min-width:1100px;
  }
  .day {
    background: var(--bg-card);
    border-radius:14px;
    padding:.6rem;
    min-height:140px;
    position:relative;
  }
  .day-header { font-size:.75rem; color:var(--text-muted); margin-bottom:.4rem; }

  .task {
    padding:.35rem .6rem;
    border-radius:8px;
    font-size:.75rem;
    font-weight:700;
    margin-bottom:.3rem;
    cursor:pointer;
  }
  .Softy { background: var(--softy); }
  .GrindMode { background: var(--grind); }
  .HardLine { background: var(--hardline); }
  .task.done { background: #2e7d32 !important; }
  .task.failed { background: #d32f2f !important; }

  .task.dragging-right { transform: translateX(40px); transition: transform .15s ease; }
  .task.dragging-left { transform: translateX(-40px); transition: transform .15s ease; }
  .empty-state { color:var(--text-muted); text-align:center; padding:1rem; }

  .edit-modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2100; }
  .edit-modal.open { display:flex; }
  .edit-card { width:min(520px,92vw); background:var(--bg-panel); padding:1rem; border-radius:12px; display:flex; flex-direction:column; gap:.6rem; }
  .edit-actions { display:flex; gap:.6rem; }
  .edit-actions button { flex:1; min-height:44px; }

  .coach-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: var(--bg-panel);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 999;
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(255,255,255,0.1);
    transition: max-height 0.18s ease;
  }
  .coach-panel-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .coach-panel-header h3 {
    margin: 0;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
  }
  .coach-panel-toggle {
    background: var(--accent);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .coach-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .coach-message {
    background: var(--bg-card);
    padding: 0.8rem;
    border-radius: 10px;
    border-left: 3px solid;
  }
  .coach-message.level-low { border-left-color: #4caf50; }
  .coach-message.level-medium { border-left-color: #ff9800; }
  .coach-message.level-high { border-left-color: #ff5722; }
  .coach-message.level-extreme { border-left-color: #d32f2f; }
  .coach-message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.4rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }
  .coach-message-body { font-size: 0.85rem; line-height: 1.4; }
  .coach-message-task { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.4rem; font-style: italic; }

  @media (max-width: 768px) {
    .coach-panel {
      width: calc(100% - 40px);
      left: 20px;
      right: 20px;
      max-height: 400px;
    }
    .task-action-row { flex-wrap: wrap; }
    .task-action-buttons { width:100%; }
    .task-action-btn { flex:1; min-height:42px; }
    .calendar-controls button, .task-form button, .menu-drawer button { min-height:44px; }
  }
</style>
</head>

<body>

<header>
  <div class="brand">
    <img src="/icons/Metrix.png" alt="Metrix HardLine" />
    <h1>Metrix HardLine</h1>
  </div>
  <div class="header-actions">
    <button class="icon-btn" id="themeToggle">üåô</button>
    <button id="menuBtn">Menu</button>
  </div>
</header>

<div class="task-action-bar" id="taskActionBar">
  <div class="task-action-row">
    <div class="task-action-title" id="taskActionTitle">Task</div>
    <div class="task-action-meta" id="taskActionMeta">Due:</div>
    <div class="task-action-buttons">
      <button class="task-action-btn done" id="taskDoneBtn">Task Done</button>
      <button class="task-action-btn failed" id="taskFailedBtn">I Failed</button>
      <button class="task-action-btn close" id="taskCloseBtn">Close</button>
    </div>
  </div>
</div>

<div class="menu-drawer" id="menuDrawer">
  <h2>Menu</h2>
  <p><strong>Username:</strong> user01</p>
  <p><strong>Email:</strong> <span id="menuEmail">user01@email.com</span></p>
  <button id="closeMenu">Close Menu</button>
  <button id="drawerLogout">Logout</button>
</div>

<main>

  <section class="stats">
    <div class="stat-card"><h3>Total Tasks</h3><p id="totalTasks">0</p></div>
    <div class="stat-card"><h3>Completed</h3><p id="completedTasks">0</p></div>
    <div class="stat-card"><h3>Failed</h3><p id="missedTasks">0</p></div>
  </section>

  <section class="kpi-row">
    <div class="kpi-card"><h3>üî• Streak</h3><div class="kpi-value" id="streakValue">0 days</div></div>
    <div class="kpi-card"><h3>Discipline Score</h3><div class="kpi-value" id="disciplineScore">0</div><div class="discipline-bar"><div class="discipline-fill" id="disciplineFill"></div></div></div>
    <div class="kpi-card"><h3>Weekly Completion</h3><div class="kpi-value" id="weeklyCompletion">0%</div></div>
  </section>

  <section class="filters">
    <select id="categoryFilter">
      <option value="all">All Categories</option>
      <option value="Study">Study</option>
      <option value="Exam">Exam</option>
      <option value="Coursework">Coursework</option>
      <option value="Personal">Personal</option>
    </select>
  </section>

  <section class="weekly-panel" id="weeklyPanel">
    <h3>Weekly Report</h3>
    <p id="weeklySummary">No data yet.</p>
  </section>

  <section class="analytics-panel">
    <h3>7-Day Completion Trend</h3>
    <canvas id="weeklyChart" class="analytics-canvas" width="1000" height="220"></canvas>
  </section>

  <section class="task-form">
    <h2>Create Task</h2>
    <div class="task-step step1 active">
      <input id="taskTitle" placeholder="Task title" />
      <button id="step1Next">Next ‚Üí</button>
    </div>
    <div class="task-step step2">
      <input id="taskDeadline" type="date"/>
      <button id="step2Next">Next ‚Üí</button>
    </div>
    <div class="task-step step3">
      <select id="taskIntensity">
        <option value="Softy">Softy</option>
        <option value="GrindMode">GrindMode</option>
        <option value="HardLine">HardLine</option>
      </select>
      <select id="taskCategory">
        <option value="Study">Study</option>
        <option value="Exam">Exam</option>
        <option value="Coursework">Coursework</option>
        <option value="Personal">Personal</option>
      </select>
      <select id="taskRecurrence">
        <option value="none">No Recurrence</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <button id="addTaskBtn">Add Task</button>
    </div>
  </section>

  <div class="calendar-controls">
    <button id="prevMonth">‚Üê Prev</button>
    <button id="nextMonth">Next ‚Üí</button>
  </div>

  <div class="calendar-wrapper">
    <section class="calendar" id="calendar"></section>
  </div>

</main>

<div class="toast-stack" id="toastStack"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-card">
    <h3>Edit Task</h3>
    <input id="editTitle" placeholder="Task title" />
    <input id="editDeadline" type="date" />
    <select id="editIntensity"><option value="Softy">Softy</option><option value="GrindMode">GrindMode</option><option value="HardLine">HardLine</option></select>
    <select id="editCategory"><option value="Study">Study</option><option value="Exam">Exam</option><option value="Coursework">Coursework</option><option value="Personal">Personal</option></select>
    <select id="editRecurrence"><option value="none">No Recurrence</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select>
    <div class="edit-actions">
      <button id="editSaveBtn">Save</button>
      <button id="editCancelBtn" class="icon-btn">Cancel</button>
    </div>
  </div>
</div>

<div class="coach-panel" id="coachPanel">
  <div class="coach-panel-header">
    <h3>üéØ Your Coach</h3>
    <button class="coach-panel-toggle" id="coachPanelToggle">Minimize</button>
  </div>
  <div class="coach-messages" id="coachMessages"></div>
</div>

<script>
(() => {
  const state = {
    tasks: window.tasks = [],
    selectedTaskId: null,
    editingTaskId: null,
    currentMonth: new Date(),
    categoryFilter: "all",
    analytics: { streak: 0, discipline: 0, weeklyCompletionRate: 0, weeklyCompleted: 0, weeklyFailed: 0, streakHistory: [] }
  };

  const menuBtn = document.getElementById('menuBtn');
  const menuDrawer = document.getElementById('menuDrawer');
  const closeMenu = document.getElementById('closeMenu');
  const drawerLogout = document.getElementById('drawerLogout');
  const themeToggle = document.getElementById('themeToggle');
  const categoryFilter = document.getElementById('categoryFilter');
  const toastStack = document.getElementById('toastStack');
  const weeklyChart = document.getElementById('weeklyChart');

  const step1 = document.querySelector('.step1');
  const step2 = document.querySelector('.step2');
  const step3 = document.querySelector('.step3');

  const taskActionBar = document.getElementById("taskActionBar");
  const taskActionTitle = document.getElementById("taskActionTitle");
  const taskActionMeta = document.getElementById("taskActionMeta");
  const taskDoneBtn = document.getElementById("taskDoneBtn");
  const taskFailedBtn = document.getElementById("taskFailedBtn");
  const taskCloseBtn = document.getElementById("taskCloseBtn");

  const editModal = document.getElementById('editModal');

  // ‚úÖ FIX: Coach minimize toggle wiring
  const coachPanel = document.getElementById('coachPanel');
  const coachPanelToggle = document.getElementById('coachPanelToggle');
  const coachMessages = document.getElementById('coachMessages');
  let coachMinimized = false;

  function applyCoachPanelState() {
    if (!coachPanel || !coachPanelToggle || !coachMessages) return;
    if (coachMinimized) {
      coachPanel.style.maxHeight = '64px';
      coachMessages.style.display = 'none';
      coachPanelToggle.textContent = 'Expand';
    } else {
      coachPanel.style.maxHeight = '';
      coachMessages.style.display = 'flex';
      coachPanelToggle.textContent = 'Minimize';
    }
  }

  if (coachPanelToggle) {
    coachPanelToggle.addEventListener('click', () => {
      coachMinimized = !coachMinimized;
      applyCoachPanelState();
    });
  }

  // Ensure correct initial state
  applyCoachPanelState();

  function notify(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = 'toast';
    if (type === 'error') toast.style.borderLeftColor = '#d32f2f';
    if (type === 'success') toast.style.borderLeftColor = '#2e7d32';
    toast.textContent = message;
    toastStack.appendChild(toast);
    setTimeout(() => toast.remove(), 3200);
  }

  function applyTheme(theme) {
    document.body.classList.toggle('light-mode', theme === 'light');
    themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('metrix_theme', theme);
  }
  applyTheme(localStorage.getItem('metrix_theme') || 'dark');
  themeToggle.onclick = () => applyTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light');

  menuBtn.onclick = ()=> menuDrawer.classList.add('open');
  closeMenu.onclick = ()=> menuDrawer.classList.remove('open');
  drawerLogout.onclick = ()=> window.logout();

  function nextDateForRecurrence(deadline, recurrence) {
    if (!deadline || recurrence === 'none') return null;
    const d = new Date(deadline + 'T00:00:00');
    if (recurrence === 'daily') d.setDate(d.getDate() + 1);
    if (recurrence === 'weekly') d.setDate(d.getDate() + 7);
    if (recurrence === 'monthly') d.setMonth(d.getMonth() + 1);
    return d.toISOString().split('T')[0];
  }

  function saveTaskLocallyAndRemote(task) {
    state.tasks.push(task);

    if (window._saveTask) {
      window._saveTask(task)
        .then(() => notify('Saved', 'success'))
        .catch((e) => {
          console.error('Save failed:', e);
          notify('Cloud save failed. Check Firestore rules / console.', 'error');
        });
    } else {
      notify('Save hook missing (_saveTask). Task only local.', 'error');
    }
  }

  function maybeCreateRecurringTask(task) {
    if (!task.recurrence || task.recurrence === 'none') return;
    const next = nextDateForRecurrence(task.deadline, task.recurrence);
    if (!next) return;
    const alreadyExists = state.tasks.some(t => t.sourceTaskId === task.id && t.deadline === next);
    if (alreadyExists) return;

    const recurringTask = {
      ...task,
      id: `${task.id}_${next}`,
      deadline: next,
      completed: false,
      failed: false,
      status: 'open',
      sourceTaskId: task.id,
      createdAt: new Date().toISOString()
    };
    saveTaskLocallyAndRemote(recurringTask);
  }

  document.getElementById('step1Next').onclick = ()=> {
    if(!document.getElementById('taskTitle').value.trim()) return notify('Enter task title', 'error');
    step1.classList.remove('active'); step2.classList.add('active');
  };
  document.getElementById('step2Next').onclick = ()=> {
    if(!document.getElementById('taskDeadline').value) return notify('Select date', 'error');
    step2.classList.remove('active'); step3.classList.add('active');
  };

  document.getElementById('addTaskBtn').onclick = ()=> {
    const title = document.getElementById('taskTitle').value.trim();
    const deadline = document.getElementById('taskDeadline').value;
    if(!title||!deadline) return notify('Missing task details', 'error');

    const task = {
      title,
      deadline,
      intensity: document.getElementById('taskIntensity').value,
      category: document.getElementById('taskCategory').value,
      recurrence: document.getElementById('taskRecurrence').value,
      completed:false,
      failed:false,
      status:'open',
      id: Date.now().toString(),
      createdAt: new Date().toISOString(),
      reminder24hSent: false,
      reminderSameDaySent: false
    };

    saveTaskLocallyAndRemote(task);

    step3.classList.remove('active'); step1.classList.add('active');
    ['taskTitle','taskDeadline'].forEach(id => document.getElementById(id).value='');
    runAllRenderers();
  };

  function openTaskBar(task) {
    state.selectedTaskId = task.id;
    taskActionTitle.textContent = task.title || 'Task';
    taskActionMeta.textContent = `Due: ${task.deadline || ''}`;
    taskActionBar.classList.add('open');
    if (window._maybeInitPushFromGesture) window._maybeInitPushFromGesture();
  }
  function closeTaskBar() {
    state.selectedTaskId = null;
    taskActionBar.classList.remove('open');
  }
  taskCloseBtn.onclick = closeTaskBar;

  function openEditModal(task) {
    if (!task) return;
    state.editingTaskId = task.id;
    document.getElementById('editTitle').value = task.title || '';
    document.getElementById('editDeadline').value = task.deadline || '';
    document.getElementById('editIntensity').value = task.intensity || 'Softy';
    document.getElementById('editCategory').value = task.category || 'Study';
    document.getElementById('editRecurrence').value = task.recurrence || 'none';
    editModal.classList.add('open');
  }

  document.getElementById('editCancelBtn').onclick = () => editModal.classList.remove('open');
  document.getElementById('editSaveBtn').onclick = () => {
    const task = state.tasks.find(t => t.id === state.editingTaskId);
    if (!task) return;
    const updates = {
      title: document.getElementById('editTitle').value.trim(),
      deadline: document.getElementById('editDeadline').value,
      intensity: document.getElementById('editIntensity').value,
      category: document.getElementById('editCategory').value,
      recurrence: document.getElementById('editRecurrence').value
    };
    Object.assign(task, updates);
    if (window._updateTaskFields) {
      window._updateTaskFields(task.id, updates).catch((e) => {
        console.error('Update failed:', e);
        notify('Edit saved locally only', 'error');
      });
    }
    editModal.classList.remove('open');
    runAllRenderers();
  };

  function applyTaskStatus(status) {
    if (!state.selectedTaskId) return;
    const t = state.tasks.find(x => x.id === state.selectedTaskId);
    if (!t) return;

    t.completed = status === 'done';
    t.failed = status === 'failed';
    t.status = status;

    if (window._updateTaskFields) {
      window._updateTaskFields(t.id, { completed: t.completed, failed: t.failed, status: t.status })
        .catch((e) => {
          console.error('Status update failed:', e);
          notify('Cloud update failed', 'error');
        });
    } else if (window._setTaskCompleted) {
      window._setTaskCompleted(t.id, t.completed).catch?.(() => {});
    }

    if (status === 'done') maybeCreateRecurringTask(t);
    runAllRenderers();
    closeTaskBar();
  }

  taskDoneBtn.onclick = () => applyTaskStatus('done');
  taskFailedBtn.onclick = () => applyTaskStatus('failed');

  const calendar = document.getElementById('calendar');
  document.getElementById('prevMonth').onclick = ()=> { state.currentMonth.setMonth(state.currentMonth.getMonth()-1); renderCalendar(); };
  document.getElementById('nextMonth').onclick = ()=> { state.currentMonth.setMonth(state.currentMonth.getMonth()+1); renderCalendar(); };

  function bindSwipe(el, task) {
    let startX = 0;
    el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive: true });
    el.addEventListener('touchmove', e => {
      const delta = e.touches[0].clientX - startX;
      el.classList.toggle('dragging-right', delta > 30);
      el.classList.toggle('dragging-left', delta < -30);
    }, { passive: true });
    el.addEventListener('touchend', e => {
      const delta = e.changedTouches[0].clientX - startX;
      el.classList.remove('dragging-right', 'dragging-left');
      if (delta > 80) { state.selectedTaskId = task.id; applyTaskStatus('done'); }
      if (delta < -80) { state.selectedTaskId = task.id; applyTaskStatus('failed'); }
    }, { passive: true });
  }

  function renderCalendar(){
    calendar.innerHTML='';
    const start = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), 1);
    const end = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth()+1, 0);
    const todayStr = new Date().toISOString().split('T')[0];

    const categoryColors = { Study:'#2196f3', Exam:'#ff9800', Coursework:'#9c27b0', Personal:'#009688' };

    for(let d=start.getDate(); d<=end.getDate(); d++){
      const dayDate = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth(), d);
      const dateStr = dayDate.toISOString().split('T')[0];
      const day = document.createElement('div');
      day.className='day';
      if(dateStr < todayStr) day.classList.add('overdue');
      day.innerHTML=`<div class="day-header">${dateStr}</div>`;

      const matches = state.tasks
        .filter(t => t.deadline === dateStr)
        .filter(t => state.categoryFilter === 'all' ? true : (t.category || 'Study') === state.categoryFilter);

      matches.forEach(t => {
        const tEl=document.createElement('div');
        const statusClass = t.failed ? ' failed' : (t.completed ? ' done' : '');
        tEl.className = `task ${t.intensity}${statusClass}`;
        tEl.style.borderLeft = `4px solid ${categoryColors[t.category||'Study'] || '#401d65'}`;
        tEl.textContent = t.title;
        tEl.onclick = ()=> openTaskBar(t);
        tEl.ondblclick = () => openEditModal(t);
        bindSwipe(tEl, t);
        day.appendChild(tEl);
      });

      if (matches.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'No tasks';
        day.appendChild(empty);
      }
      calendar.appendChild(day);
    }
  }

  function getDateKey(dateObj) { return new Date(dateObj).toISOString().split('T')[0]; }

  function getWeekRange() {
    const now = new Date(); now.setHours(0,0,0,0);
    const start = new Date(now); start.setDate(now.getDate() - 6);
    return {start, end: now};
  }

  function calculateAnalytics() {
    const { start, end } = getWeekRange();
    const endKey = getDateKey(end);

    const openOverdue = state.tasks.filter(t => !t.completed && !t.failed && t.deadline < endKey).length;
    const weekly = state.tasks.filter(t => t.deadline >= getDateKey(start) && t.deadline <= endKey);
    const completed = weekly.filter(t => t.completed).length;
    const failed = weekly.filter(t => t.failed).length;
    const total = Math.max(weekly.length, 1);
    const weeklyCompletionRate = Math.round((completed / total) * 100);

    const completionRate = state.tasks.length ? (state.tasks.filter(t => t.completed).length / state.tasks.length) : 0;
    const discipline = Math.max(0, Math.min(100, Math.round(completionRate * 70 + Math.min(state.analytics.streak, 30) - openOverdue * 3)));

    let streak = 0;
    const streakHistory = [];
    for (let i = 0; i < 60; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      const key = getDateKey(d);
      const dueTasks = state.tasks.filter(t => t.deadline === key);
      if (!dueTasks.length) continue;
      const dayCompleted = dueTasks.every(t => t.completed);
      streakHistory.push({ date: key, completed: dayCompleted });
      if (i === 0 || streak > 0) {
        if (dayCompleted) streak += 1; else if (i > 0) break;
      }
    }

    state.analytics = { ...state.analytics, streak, discipline, weeklyCompletionRate, weeklyCompleted: completed, weeklyFailed: failed, streakHistory };
  }

  function renderTopMetrics() {
    document.getElementById('streakValue').textContent = `${state.analytics.streak} days`;
    document.getElementById('disciplineScore').textContent = String(state.analytics.discipline);
    document.getElementById('disciplineFill').style.width = `${state.analytics.discipline}%`;
    document.getElementById('weeklyCompletion').textContent = `${state.analytics.weeklyCompletionRate}%`;
    document.getElementById('weeklySummary').textContent = `Completed: ${state.analytics.weeklyCompleted} ‚Ä¢ Failed: ${state.analytics.weeklyFailed} ‚Ä¢ Rate: ${state.analytics.weeklyCompletionRate}%`;

    if (window._persistUserAnalytics) window._persistUserAnalytics(state.analytics);
    if (window._persistWeeklyStats) window._persistWeeklyStats(state.analytics);
  }

  function drawWeeklyChart() {
    if (!weeklyChart) return;
    const ctx = weeklyChart.getContext('2d');
    const w = weeklyChart.width, h = weeklyChart.height;
    ctx.clearRect(0,0,w,h);

    const bars = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(); d.setDate(d.getDate()-i);
      const key = getDateKey(d);
      bars.push(state.tasks.filter(t => t.completed && t.deadline === key).length);
    }

    const max = Math.max(1, ...bars);
    const bw = (w - 80) / 7;

    ctx.font = "14px DM Sans";
    bars.forEach((v, i) => {
      const bh = (v / max) * (h - 60);
      const x = 40 + i * bw;
      const y = h - 30 - bh;
      ctx.fillStyle = '#401d65';
      ctx.fillRect(x + 8, y, bw - 16, bh);
      ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted');
      ctx.fillText(String(v), x + bw/2 - 4, y - 6);
    });
  }

  function updateStats(){
    document.getElementById('totalTasks').textContent = state.tasks.length;
    document.getElementById('completedTasks').textContent = state.tasks.filter(t=>t.completed).length;
    document.getElementById('missedTasks').textContent = state.tasks.filter(t=>t.failed).length;
  }

  function runAllRenderers() {
    calculateAnalytics();
    renderCalendar();
    updateStats();
    renderTopMetrics();
    drawWeeklyChart();
  }

  window.renderCalendar = renderCalendar;
  window.updateStats = updateStats;

  categoryFilter.onchange = (e) => { state.categoryFilter = e.target.value; renderCalendar(); };

  // ====== FIXED HYDRATION (YOUR TASK SAVE FIX) ======
  window._dashboardHydrate = async (loadedTasks, userProfile = {}) => {
    const snapshot = Array.isArray(loadedTasks) ? loadedTasks.map(t => ({ ...t })) : [];
    state.tasks.length = 0;
    snapshot.forEach(t => state.tasks.push(t));
    state.analytics.streak = Number(userProfile.streakCount || 0);
    state.analytics.streakHistory = userProfile.streakHistory || [];
    runAllRenderers();
  };

  runAllRenderers();
})();
</script>

<!-- ‚úÖ FIREBASE AUTH + FIRESTORE + FCM TOKEN SAVE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    updateDoc,
    getDoc,
    getDocs,
    query,
    orderBy,
    limit,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBqQF1Tijz_wctD0Z7kSCB80DeiWY1ZPyw",
    authDomain: "metrix-hardline.firebaseapp.com",
    projectId: "metrix-hardline",
    storageBucket: "metrix-hardline.firebasestorage.app",
    messagingSenderId: "899994703104",
    appId: "1:899994703104:web:2979fe39d1c3c169ee4fe5"
  };

  const FCM_VAPID_KEY = "BEH0GI6sTAl39BH8VaKsBQuoit6skekTlIOa2AZfmRc7JK56onlsx_PjhdjRSxM3qb2LMf0hHpF6iDrY9LJpnYU";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const messaging = getMessaging(app);

  async function enforceSubscriptionGate(uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : null;
    const active = data?.subscriptionActive === true;

    if (!active) {
      try { await signOut(auth); } catch {}
      localStorage.removeItem("uid");
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  async function loadTasks(uid) {
    const snap = await getDocs(collection(db, "users", uid, "tasks"));
    const loaded = [];
    snap.forEach(d => loaded.push(d.data()));

    loaded.forEach(t => {
      if (typeof t.failed === "undefined") t.failed = false;
      if (typeof t.status === "undefined") t.status = t.completed ? "done" : "open";
      if (typeof t.category === "undefined") t.category = "Study";
      if (typeof t.recurrence === "undefined") t.recurrence = "none";
      if (typeof t.reminder24hSent === "undefined") t.reminder24hSent = false;
      if (typeof t.reminderSameDaySent === "undefined") t.reminderSameDaySent = false;
    });

    window.tasks.length = 0;
    loaded.forEach(t => window.tasks.push(t));
  }

  async function saveUserAnalytics(uid, analytics) {
    await setDoc(doc(db, "users", uid), {
      streakCount: Number(analytics.streak || 0),
      disciplineScore: Number(analytics.discipline || 0),
      weeklyCompletionRate: Number(analytics.weeklyCompletionRate || 0),
      streakHistory: analytics.streakHistory || [],
      analyticsUpdatedAt: serverTimestamp()
    }, { merge: true });
  }

  async function saveWeeklyStats(uid, analytics) {
    const now = new Date();
    const weekId = `${now.getUTCFullYear()}-W${String(Math.ceil((((now - new Date(Date.UTC(now.getUTCFullYear(),0,1))) / 86400000) + new Date(Date.UTC(now.getUTCFullYear(),0,1)).getUTCDay()+1) / 7)).padStart(2,'0')}`;
    await setDoc(doc(db, "users", uid, "weeklyStats", weekId), {
      completed: Number(analytics.weeklyCompleted || 0),
      failed: Number(analytics.weeklyFailed || 0),
      completionRate: Number(analytics.weeklyCompletionRate || 0),
      streak: Number(analytics.streak || 0),
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  async function loadUserProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    return snap.exists() ? snap.data() : {};
  }

  async function saveTask(uid, task) {
    await setDoc(doc(db, "users", uid, "tasks", task.id), task, { merge: true });
  }

  async function setTaskCompleted(uid, taskId, completed) {
    await updateDoc(doc(db, "users", uid, "tasks", taskId), { completed });
  }

  async function updateTaskFields(uid, taskId, updates) {
    await updateDoc(doc(db, "users", uid, "tasks", taskId), updates);
  }

  window._saveTask = (task) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return Promise.reject(new Error("No uid in localStorage"));
    return saveTask(uid, task);
  };

  window._setTaskCompleted = (taskId, completed) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return Promise.reject(new Error("No uid in localStorage"));
    return setTaskCompleted(uid, taskId, completed);
  };

  window._updateTaskFields = (taskId, updates) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return Promise.reject(new Error("No uid in localStorage"));
    return updateTaskFields(uid, taskId, updates);
  };

  window._persistUserAnalytics = (analytics) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return saveUserAnalytics(uid, analytics).catch(() => {});
  };

  window._persistWeeklyStats = (analytics) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return saveWeeklyStats(uid, analytics).catch(() => {});
  };

  async function loadCoachMessages(uid) {
    const q = query(
      collection(db, "users", uid, "coachMessages"),
      orderBy("timestamp"),
      limit(200)
    );
    const snap = await getDocs(q);
    const msgs = [];
    snap.forEach(d => msgs.push(d.data()));
    localStorage.setItem("metrix_coach_messages", JSON.stringify(msgs));

    const container = document.getElementById("coachMessages");
    if (container) {
      container.innerHTML = "";
      msgs.forEach(m => {
        if (m.type !== "panel") return;
        const messageEl = document.createElement('div');
        messageEl.className = `coach-message level-${m.level}`;
        messageEl.innerHTML = `
          <div class="coach-message-header">
            <span>üéØ Coach</span>
            <span>${new Date(m.timestamp || Date.now()).toLocaleTimeString()}</span>
          </div>
          <div class="coach-message-body">${m.message}</div>
          <div class="coach-message-task">Re: ${m.taskTitle || ""}</div>
        `;
        container.appendChild(messageEl);
      });
      container.scrollTop = container.scrollHeight;
    }
  }

  async function persistCoachMessage(uid, msg) {
    await addDoc(collection(db, "users", uid, "coachMessages"), {
      ...msg,
      createdAt: serverTimestamp()
    });
  }

  window._persistCoachMessage = (msg) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    persistCoachMessage(uid, msg).catch(() => {});
  };

  async function saveFcmToken(uid, token) {
    await setDoc(doc(db, "users", uid, "fcmTokens", token), {
      token,
      platform: navigator.userAgent || "",
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  let didInitPush = false;

  async function initPushWithUserGesture() {
    if (didInitPush) return;
    didInitPush = true;

    try {
      if (!("Notification" in window)) return;

      if (Notification.permission === "default") {
        const perm = await Notification.requestPermission();
        if (perm !== "granted") return;
      }
      if (Notification.permission !== "granted") return;

      const swReg = await navigator.serviceWorker.register("/sw.js");

      const token = await getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: swReg
      });

      if (!token) return;

      const uid = localStorage.getItem("uid");
      if (!uid) return;

      await saveFcmToken(uid, token);
    } catch (e) {
      console.log("Push init error:", e);
    }
  }

  window._maybeInitPushFromGesture = initPushWithUserGesture;

  onMessage(messaging, (payload) => {
    try {
      if (Notification.permission === "granted" && payload?.notification?.body) {
        new Notification(payload.notification.title || "Metrix Coach", {
          body: payload.notification.body
        });
      }
    } catch {}
  });

  window._queuePushCoach = async ({ title, body }) => {
    try {
      const user = auth.currentUser;
      if (!user) return;

      const idToken = await user.getIdToken();

      await fetch("/api/send-push", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${idToken}`
        },
        body: JSON.stringify({
          title: title || "Metrix Coach",
          body: body || "",
          url: "/user-dashboard.html"
        })
      });
    } catch {}
  };

  window.logout = function () {
    signOut(auth).finally(() => {
      localStorage.removeItem("uid");
      window.location.href = "login.html";
    });
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    localStorage.setItem("uid", user.uid);

    const ok = await enforceSubscriptionGate(user.uid);
    if (!ok) return;

    const emailEl = document.getElementById("menuEmail");
    if (emailEl) emailEl.textContent = user.email || "";

    await loadTasks(user.uid);
    await loadCoachMessages(user.uid);
    const userProfile = await loadUserProfile(user.uid);

    const snapshot = window.tasks.map(t => ({ ...t }));

    if (typeof window._dashboardHydrate === "function") {
      await window._dashboardHydrate(snapshot, userProfile);
    } else {
      if (typeof window.renderCalendar === "function") window.renderCalendar();
      if (typeof window.updateStats === "function") window.updateStats();
    }
  });
</script>

</body>
</html>
