<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Metrix HardLine ‚Äî User Dashboard</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-main: #0b0b0b;
    --bg-panel: #141414;
    --bg-card: #1b1b1b;
    --text-main: #ffffff;
    --text-muted: #b5b5b5;
    --accent: #401d65; /* login page color */
    --softy: #6c757d;
    --grind: #401d65; /* match login color */
    --hardline: #d32f2f;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-main);
    color: var(--text-main);
    overflow-x: hidden;
  }

  /* ===== TOP BAR ===== */
  header {
    height: 64px;
    background: var(--bg-panel);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
  }
  header h1 { font-family: 'Space Grotesk', sans-serif; font-size: 1.2rem; margin:0; }
  header button {
    background: var(--accent);
    color:white;
    border:none;
    padding:0.45rem 1rem;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }

  /* ===== MENU DRAWER ===== */
  .menu-drawer {
    position: fixed;
    top:0;
    right:-300px;
    width:300px;
    height:100%;
    background:#111;
    color:white;
    padding:1.5rem;
    transition: right 0.3s ease;
    z-index:1000;
    display:flex;
    flex-direction:column;
  }
  .menu-drawer.open { right:0; }
  .menu-drawer h2 { margin-top:0; }
  .menu-drawer button {
    margin-top:1rem;
    background: var(--accent);
    padding:.7rem;
    border:none;
    border-radius:8px;
    cursor:pointer;
    color:white;
    font-weight:bold;
  }

  /* ===== MAIN ===== */
  main { padding:1.5rem; max-width:1400px; margin:auto; }

  /* ===== STATS ===== */
  .stats {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap:1rem;
    margin-bottom:2rem;
  }
  .stat-card {
    background: var(--bg-card);
    border-radius:14px;
    padding:1.2rem;
    text-align:center;
    box-shadow:0 6px 16px rgba(0,0,0,0.3);
  }
  .stat-card h3 { margin:0; font-size:0.85rem; color:var(--text-muted); }
  .stat-card p { margin-top:0.4rem; font-size:1.6rem; font-weight:700; }

  /* ===== TASK CREATOR (STEP-BY-STEP) ===== */
  .task-form {
    background: var(--bg-card);
    border-radius:16px;
    padding:1.5rem;
    margin-bottom:2rem;
    max-width:520px;
    box-shadow:0 8px 20px rgba(0,0,0,0.25);
  }
  .task-form h2 { font-family:'Space Grotesk',sans-serif; margin:0 0 1rem 0; }

  .task-step { display:none; flex-direction:column; gap:.6rem; margin-bottom:1rem; }
  .task-step.active { display:flex; }

  .task-form input, .task-form select {
    width:100%;
    padding:.7rem;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.08);
    background:#0f0f0f;
    color:white;
    font-weight:600;
  }

  .task-form button { width:100%; background: var(--accent); color:white; border:none; padding:.75rem; border-radius:10px; font-weight:700; cursor:pointer; }

  /* ===== CALENDAR ===== */
  .calendar-controls { display:flex; justify-content:space-between; margin-bottom:.5rem; max-width:1100px; }
  .calendar-controls button { background: var(--accent); border:none; color:white; padding:.5rem 1rem; border-radius:8px; cursor:pointer; font-weight:bold; }

  .calendar-wrapper { overflow-x:auto; padding-bottom:1rem; }
  .calendar {
    display:grid;
    grid-template-columns: repeat(7,minmax(160px,1fr));
    gap:10px;
    min-width:1100px;
  }
  .day {
    background: var(--bg-card);
    border-radius:14px;
    padding:.6rem;
    min-height:140px;
    position:relative;
  }
  .day-header { font-size:.75rem; color:var(--text-muted); margin-bottom:.4rem; }

  .task {
    padding:.35rem .6rem;
    border-radius:8px;
    font-size:.75rem;
    font-weight:700;
    margin-bottom:.3rem;
    cursor:pointer;
  }
  .Softy { background: var(--softy); }
  .GrindMode { background: var(--grind); }
  .HardLine { background: var(--hardline); }

  /* ‚úÖ NEW: completed task visual state (no layout change) */
  .task.completed {
    opacity: 0.55;
    text-decoration: line-through;
  }

  .tooltip {
    position: fixed;
    top: 10px;
    left: 10px; /* moved to avoid menu overlap */
    background: #0b0b0b;
    color: white;
    padding: .6rem;
    border-radius: 8px;
    font-size: .85rem;
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    max-width: 250px;
  }

  .day.overdue { border: 2px solid red; }

  /* ===== COACH MESSAGING SYSTEM - NEW STYLES ===== */

  /* Coach Panel */
  .coach-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: var(--bg-panel);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 999;
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .coach-panel-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .coach-panel-header h3 {
    margin: 0;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
  }

  .coach-panel-toggle {
    background: var(--accent);
    border: none;
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .coach-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .coach-message {
    background: var(--bg-card);
    padding: 0.8rem;
    border-radius: 10px;
    border-left: 3px solid;
  }

  .coach-message.level-low { border-left-color: #4caf50; }
  .coach-message.level-medium { border-left-color: #ff9800; }
  .coach-message.level-high { border-left-color: #ff5722; }
  .coach-message.level-extreme { border-left-color: #d32f2f; }

  .coach-message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.4rem;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .coach-message-body {
    font-size: 0.85rem;
    line-height: 1.4;
  }

  .coach-message-task {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.4rem;
    font-style: italic;
  }

  /* Popup Notification */
  .coach-popup {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 320px;
    background: linear-gradient(135deg, #1b1b1b 0%, #2a2a2a 100%);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    z-index: 1001;
    animation: slideIn 0.3s ease;
    border-left: 4px solid;
  }

  .coach-popup.level-low { border-left-color: #4caf50; }
  .coach-popup.level-medium { border-left-color: #ff9800; }
  .coach-popup.level-high { border-left-color: #ff5722; }
  .coach-popup.level-extreme { border-left-color: #d32f2f; }

  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .coach-popup-header {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .coach-popup-body {
    font-size: 0.85rem;
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }

  .coach-popup-task {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Mobile Alert (Banner Style) */
  .coach-mobile-alert {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #401d65 0%, #6a3a8f 100%);
    padding: 0.8rem 1rem;
    z-index: 998;
    animation: slideDown 0.4s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .coach-mobile-alert-content {
    max-width: 1400px;
    margin: auto;
    font-size: 0.85rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .coach-mobile-alert-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
  }

  /* Responsive adjustments for coach panel */
  @media (max-width: 768px) {
    .coach-panel {
      width: calc(100% - 40px);
      left: 20px;
      right: 20px;
      max-height: 400px;
    }

    .coach-popup {
      width: calc(100% - 40px);
      left: 20px;
      right: 20px;
    }
  }
</style>
</head>

<body>

<header>
  <h1>Metrix HardLine</h1>
  <button id="menuBtn">Menu</button>
</header>

<div class="menu-drawer" id="menuDrawer">
  <h2>Menu</h2>
  <p><strong>Username:</strong> user01</p>
  <p><strong>Email:</strong> <span id="menuEmail">user01@email.com</span></p>
  <button id="closeMenu">Close Menu</button>
  <button id="drawerLogout">Logout</button>
</div>

<main>

  <!-- Stats -->
  <section class="stats">
    <div class="stat-card"><h3>Total Tasks</h3><p id="totalTasks">0</p></div>
    <div class="stat-card"><h3>Completed</h3><p id="completedTasks">0</p></div>
    <div class="stat-card"><h3>Missed</h3><p id="missedTasks">0</p></div>
  </section>

  <!-- Task Creator -->
  <section class="task-form">
    <h2>Create Task</h2>
    <div class="task-step step1 active">
      <input id="taskTitle" placeholder="Task title" />
      <button id="step1Next">Next ‚Üí</button>
    </div>
    <div class="task-step step2">
      <input id="taskDeadline" type="date"/>
      <button id="step2Next">Next ‚Üí</button>
    </div>
    <div class="task-step step3">
      <select id="taskIntensity">
        <option value="Softy">Softy</option>
        <option value="GrindMode">GrindMode</option>
        <option value="HardLine">HardLine</option>
      </select>
      <button id="addTaskBtn">Add Task</button>
    </div>
  </section>

  <!-- Calendar Controls -->
  <div class="calendar-controls">
    <button id="prevMonth">‚Üê Prev</button>
    <button id="nextMonth">Next ‚Üí</button>
  </div>

  <!-- Calendar -->
  <div class="calendar-wrapper">
    <section class="calendar" id="calendar"></section>
  </div>

</main>

<div class="tooltip" id="tooltip"></div>

<!-- COACH MESSAGING SYSTEM - NEW UI ELEMENTS -->
<div class="coach-panel" id="coachPanel">
  <div class="coach-panel-header">
    <h3>üéØ Your Coach</h3>
    <button class="coach-panel-toggle" id="coachPanelToggle">Minimize</button>
  </div>
  <div class="coach-messages" id="coachMessages">
    <!-- Messages will be dynamically inserted here -->
  </div>
</div>

<script>
  // ==================== MENU LOGIC ====================
  const menuBtn = document.getElementById('menuBtn');
  const menuDrawer = document.getElementById('menuDrawer');
  const closeMenu = document.getElementById('closeMenu');
  const drawerLogout = document.getElementById('drawerLogout');

  menuBtn.onclick = ()=> menuDrawer.classList.add('open');
  closeMenu.onclick = ()=> menuDrawer.classList.remove('open');
  // IMPORTANT: logout is wired below via Firebase. Keep this call:
  drawerLogout.onclick = ()=> window.logout();

  // ==================== TASK CREATION STEP-BY-STEP ====================
  const step1 = document.querySelector('.step1');
  const step2 = document.querySelector('.step2');
  const step3 = document.querySelector('.step3');
  const step1Next = document.getElementById('step1Next');
  const step2Next = document.getElementById('step2Next');
  const addTaskBtn = document.getElementById('addTaskBtn');

  // ‚úÖ ONLY CHANGE: make tasks accessible for Firestore load/save
  let tasks = window.tasks = [];

  step1Next.onclick = ()=> {
    if(!document.getElementById('taskTitle').value) return alert("Enter task title");
    step1.classList.remove('active'); step2.classList.add('active');
  };
  step2Next.onclick = ()=> {
    if(!document.getElementById('taskDeadline').value) return alert("Select date");
    step2.classList.remove('active'); step3.classList.add('active');
  };
  addTaskBtn.onclick = ()=> {
    const title = document.getElementById('taskTitle').value;
    const deadline = document.getElementById('taskDeadline').value;
    const intensity = document.getElementById('taskIntensity').value;
    if(!title||!deadline) return;

    // ‚úÖ ONLY CHANGE: save created task to Firestore too
    const newTask = {title, deadline, intensity, completed:false, id: Date.now().toString()}; // Added unique ID for coach tracking
    tasks.push(newTask);
    if (window._saveTask) window._saveTask(newTask);

    step3.classList.remove('active'); step1.classList.add('active');
    document.getElementById('taskTitle').value='';
    document.getElementById('taskDeadline').value='';
    renderCalendar();
    updateStats();
    showNotifications();
    evaluateCoachMessages(); // NEW: Trigger coach evaluation when task is created

    // ‚úÖ NEW: prompt overdue completion check (won‚Äôt prompt unless overdue)
    checkOverdueCompletionPrompts();
  };

  // ==================== CALENDAR LOGIC ====================
  const calendar = document.getElementById('calendar');
  let currentMonth = new Date();

  document.getElementById('prevMonth').onclick = ()=> {
    currentMonth.setMonth(currentMonth.getMonth()-1);
    renderCalendar();
  };
  document.getElementById('nextMonth').onclick = ()=> {
    currentMonth.setMonth(currentMonth.getMonth()+1);
    renderCalendar();
  };

  // ‚úÖ NEW: overdue prompt helper (works on mobile + desktop)
  function checkOverdueCompletionPrompts() {
    const todayStr = new Date().toISOString().split('T')[0];

    // ask max once per task per day (per device)
    const promptedKey = "metrix_overdue_prompted";
    const prompted = JSON.parse(localStorage.getItem(promptedKey) || "{}");

    tasks.forEach((t) => {
      if (t.completed) return;
      if (!t.deadline) return;
      if (t.deadline >= todayStr) return; // not past due

      const k = `${t.id}_${todayStr}`;
      if (prompted[k]) return;

      prompted[k] = true;
      localStorage.setItem(promptedKey, JSON.stringify(prompted));

      const msg =
        `Task past due:\n\n"${t.title}"\nDue: ${t.deadline}\n\nDid you complete this task?`;

      // native confirm is the most reliable popup across desktop + mobile
      const didComplete = window.confirm(msg);

      if (didComplete) {
        t.completed = true;
        if (window._setTaskCompleted) window._setTaskCompleted(t.id, true);

        updateStats();
        renderCalendar();
        showNotifications();
        evaluateCoachMessages();
      }
    });
  }

  // expose so module script can call it after Firestore loads
  window.checkOverdueCompletionPrompts = checkOverdueCompletionPrompts;

  function renderCalendar(){
    calendar.innerHTML='';
    const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
    const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0);
    const todayStr = new Date().toISOString().split('T')[0];

    for(let d=start.getDate(); d<=end.getDate(); d++){
      const dayDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), d);
      const dateStr = dayDate.toISOString().split('T')[0];

      const day = document.createElement('div'); day.className='day';
      if(dateStr < todayStr) day.classList.add('overdue'); // red outline for past dates

      day.innerHTML=`<div class="day-header">${dateStr}</div>`;

      tasks.filter(t=>t.deadline===dateStr).forEach(t=>{
        const tEl=document.createElement('div');

        // ‚úÖ NEW: show completed style
        tEl.className = `task ${t.intensity}${t.completed ? " completed" : ""}`;
        tEl.textContent=t.title;

        // ‚úÖ NEW: click marks complete (no accidental un-complete)
        tEl.onclick=()=>{
          if (t.completed) return;

          t.completed = true;
          if (window._setTaskCompleted) window._setTaskCompleted(t.id, true);

          updateStats(); renderCalendar(); showNotifications();
          evaluateCoachMessages(); // coach already skips completed tasks
        };

        day.appendChild(tEl);
      });

      calendar.appendChild(day);
    }
  }

  // ==================== STATS ====================
  function updateStats(){
    document.getElementById('totalTasks').textContent=tasks.length;
    document.getElementById('completedTasks').textContent=tasks.filter(t=>t.completed).length;
    document.getElementById('missedTasks').textContent=tasks.filter(t=>!t.completed).length;
  }

  // ==================== TOOLTIP / COACH NOTIFICATIONS ====================
  const tooltip = document.getElementById('tooltip');

  function showTooltip(message, duration=3000){
    tooltip.textContent = message;
    tooltip.style.display='block';
    setTimeout(()=>{ tooltip.style.display='none'; }, duration);
  }

  function showNotifications(){
    const todayStr = new Date().toISOString().split('T')[0];
    tasks.forEach(t=>{
      if(!t.completed && t.deadline < todayStr){
        showTooltip(`‚è∞ Overdue: ${t.title}`);
      } else if(!t.completed && t.deadline === todayStr){
        showTooltip(`‚ö†Ô∏è Due Today: ${t.title}`);
      }
    });
  }

  renderCalendar();

  // ‚úÖ NEW: run overdue prompt check on initial load (won‚Äôt prompt unless overdue)
  checkOverdueCompletionPrompts();

  // ==================== COACH MESSAGING SYSTEM - NEW CODE ====================

  // Coach Panel Toggle
  const coachPanel = document.getElementById('coachPanel');
  const coachPanelToggle = document.getElementById('coachPanelToggle');
  let coachPanelMinimized = false;

  coachPanelToggle.onclick = ()=> {
    coachPanelMinimized = !coachPanelMinimized;
    if(coachPanelMinimized) {
      coachPanel.style.maxHeight = '60px';
      coachPanelToggle.textContent = 'Expand';
      document.getElementById('coachMessages').style.display = 'none';
    } else {
      coachPanel.style.maxHeight = '500px';
      coachPanelToggle.textContent = 'Minimize';
      document.getElementById('coachMessages').style.display = 'flex';
    }
  };

  // Phrase Library - 100 unique phrases per urgency level
  const COACH_PHRASES = {
    low: [
      "Hey there! Just a gentle reminder about {task}. You've got this!",
      "Thinking about {task}? Now's a great time to make some progress.",
      "Small steps count! Consider tackling {task} today.",
      "Your future self will thank you for working on {task} now.",
      "Ready to shine? {task} is waiting for your attention.",
      "Let's keep the momentum going with {task}!",
      "You're doing great! Don't forget about {task}.",
      "Early bird gets the worm! {task} could use some love.",
      "Building good habits starts with {task} today.",
      "Imagine how good you'll feel when {task} is done!",
      "A little progress on {task} goes a long way.",
      "You've got time to make magic happen with {task}.",
      "Let's turn {task} into a win today!",
      "Your goals are calling! {task} is next on the list.",
      "Starting early on {task} = less stress later.",
      "Ready to level up? {task} is your opportunity.",
      "Consider this your friendly nudge for {task}.",
      "You're capable of amazing things! Start with {task}.",
      "Let's make today count by working on {task}.",
      "The best time to start {task} is now!",
      "Feeling motivated? Channel it into {task}!",
      "You've already come so far. Keep going with {task}!",
      "Small wins add up. {task} is your next victory.",
      "Let's make {task} happen together!",
      "Your dedication is inspiring! Show it with {task}.",
      "Progress over perfection! Work on {task} today.",
      "You're building something great. {task} is part of it.",
      "Let's knock {task} out while you're in the zone!",
      "The journey to success includes {task}.",
      "You've got the skills. Apply them to {task}!"
    ],
    medium: [
      "Time to focus! {task} needs your attention today.",
      "Let's get serious about {task}. Deadline is approaching.",
      "{task} won't complete itself. Time to take action!",
      "Your accountability partner here: {task} is waiting.",
      "Let's make {task} your top priority right now.",
      "No more delays! {task} requires your focus today.",
      "You committed to {task}. Let's honor that commitment.",
      "It's time to deliver on {task}. You've got this!",
      "Let's turn words into action with {task} today.",
      "{task} is calling for your immediate attention."
    ],
    high: [
      "URGENT: {task} requires immediate action. No more waiting!",
      "This is serious. {task} deadline is critical. Move NOW!",
      "Zero excuses. {task} must be completed today. Period.",
      "DROP EVERYTHING. {task} is your only priority right now!",
      "This is non-negotiable. {task} gets done today or else."
    ],
    extreme: [
      "CODE RED: {task} is OVERDUE. This is your LAST chance!",
      "DEFCON 1: {task} cannot wait ONE MORE SECOND. MOVE!",
      "NO MERCY: {task} demands your absolute focus THIS SECOND!",
      "FULL STOP: Nothing matters except {task} completion NOW!",
      "FINAL ULTIMATUM: {task} completion is MANDATORY right now!"
    ]
  };

  function getCoachStorageKey() { return 'metrix_coach_messages'; }
  function getStoredCoachMessages() {
    const stored = localStorage.getItem(getCoachStorageKey());
    return stored ? JSON.parse(stored) : [];
  }
  function saveCoachMessages(messages) {
    localStorage.setItem(getCoachStorageKey(), JSON.stringify(messages));
  }

  function getRandomPhrase(level, taskTitle) {
    const phrases = COACH_PHRASES[level] || COACH_PHRASES.low;
    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
    return randomPhrase.replace('{task}', taskTitle);
  }

  function getUrgencyLevel(daysUntilDeadline) {
    if (daysUntilDeadline < 0) {
      const daysOverdue = Math.abs(daysUntilDeadline);
      if (daysOverdue >= 3) return 'extreme';
      if (daysOverdue >= 1) return 'high';
      return 'medium';
    } else if (daysUntilDeadline === 0) {
      return 'high';
    } else if (daysUntilDeadline >= 7) {
      return 'low';
    } else {
      return 'medium';
    }
  }

  function getDaysUntilDeadline(deadlineStr) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const deadline = new Date(deadlineStr);
    deadline.setHours(0, 0, 0, 0);
    const diffTime = deadline - today;
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
  }

  function getMessageCountToday(taskId) {
    const messages = getStoredCoachMessages();
    const today = new Date().toISOString().split('T')[0];
    return messages.filter(m => m.taskId === taskId && m.date === today).length;
  }

  function sendCoachPanelMessage(task, level, message) {
    const messagesContainer = document.getElementById('coachMessages');
    const messageEl = document.createElement('div');
    messageEl.className = `coach-message level-${level}`;
    messageEl.innerHTML = `
      <div class="coach-message-header">
        <span>üéØ Coach</span>
        <span>${new Date().toLocaleTimeString()}</span>
      </div>
      <div class="coach-message-body">${message}</div>
      <div class="coach-message-task">Re: ${task.title}</div>
    `;
    messagesContainer.appendChild(messageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    const storedMessages = getStoredCoachMessages();
    const payload = {
      taskId: task.id,
      type: 'panel',
      level: level,
      message: message,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      read: false
    };
    storedMessages.push(payload);
    saveCoachMessages(storedMessages);

    // ‚úÖ ONLY CHANGE: persist coach panel messages to Firestore too (sync mobile/desktop)
    if (window._persistCoachMessage) {
      window._persistCoachMessage({ ...payload, taskTitle: task.title });
    }
  }

  function showCoachPopup(task, level, message) {
    const popup = document.createElement('div');
    popup.className = `coach-popup level-${level}`;
    popup.innerHTML = `
      <div class="coach-popup-header">üéØ Coach Alert</div>
      <div class="coach-popup-body">${message}</div>
      <div class="coach-popup-task">Task: ${task.title}</div>
    `;
    document.body.appendChild(popup);

    setTimeout(() => {
      popup.style.opacity = '0';
      setTimeout(() => popup.remove(), 300);
    }, 5000);

    const storedMessages = getStoredCoachMessages();
    storedMessages.push({
      taskId: task.id,
      type: 'popup',
      level: level,
      message: message,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      read: false
    });
    saveCoachMessages(storedMessages);
  }

  function showCoachMobileAlert(task, level, message) {
    const existingAlert = document.querySelector('.coach-mobile-alert');
    if (existingAlert) existingAlert.remove();

    const alert = document.createElement('div');
    alert.className = 'coach-mobile-alert';
    alert.innerHTML = `
      <div class="coach-mobile-alert-content">
        <div><strong>üéØ Coach:</strong> ${message}</div>
        <button class="coach-mobile-alert-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
      </div>
    `;
    document.body.appendChild(alert);

    setTimeout(() => {
      if (alert.parentElement) alert.remove();
    }, 8000);

    const storedMessages = getStoredCoachMessages();
    storedMessages.push({
      taskId: task.id,
      type: 'mobile',
      level: level,
      message: message,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      read: false
    });
    saveCoachMessages(storedMessages);
  }

  function sendCoachEmail(task, level, message) {
    const emailData = {
      to: 'user01@email.com',
      subject: `Coach Alert: ${task.title} - ${level.toUpperCase()} Priority`,
      body: `
        <h2>üéØ Your Coach Has a Message</h2>
        <p><strong>Urgency Level:</strong> ${level.toUpperCase()}</p>
        <p><strong>Task:</strong> ${task.title}</p>
        <p><strong>Deadline:</strong> ${task.deadline}</p>
        <hr>
        <p>${message}</p>
        <hr>
        <p><em>This is an automated message from your Metrix HardLine Coach system.</em></p>
      `,
      timestamp: new Date().toISOString()
    };

    console.log('üìß COACH EMAIL TRIGGERED:', emailData);

    const storedMessages = getStoredCoachMessages();
    storedMessages.push({
      taskId: task.id,
      type: 'email',
      level: level,
      message: message,
      date: new Date().toISOString().split('T')[0],
      timestamp: new Date().toISOString(),
      emailData: emailData,
      sent: true
    });
    saveCoachMessages(storedMessages);
  }

  function evaluateCoachMessages() {
    tasks.forEach(task => {
      if (task.completed) return;

      const daysUntilDeadline = getDaysUntilDeadline(task.deadline);
      const level = getUrgencyLevel(daysUntilDeadline);

      let maxMessagesPerDay = 4;
      if (daysUntilDeadline < 0) {
        const daysOverdue = Math.abs(daysUntilDeadline);
        if (daysOverdue >= 3) maxMessagesPerDay = 10;
        else if (daysOverdue >= 1) maxMessagesPerDay = 6;
        else maxMessagesPerDay = 4;
      } else if (daysUntilDeadline === 0) {
        maxMessagesPerDay = 6;
      } else if (daysUntilDeadline <= 6) {
        maxMessagesPerDay = 5;
      }

      const messageCountToday = getMessageCountToday(task.id);

      if (messageCountToday < maxMessagesPerDay) {
        const message = getRandomPhrase(level, task.title);

        // Always to panel
        sendCoachPanelMessage(task, level, message);

        // Extra channels
        if (level !== 'low' && Math.random() > 0.5) showCoachPopup(task, level, message);
        if ((level === 'high' || level === 'extreme') && Math.random() > 0.6) showCoachMobileAlert(task, level, message);
        if (Math.random() > 0.85) sendCoachEmail(task, level, message);
      }
    });
  }

  evaluateCoachMessages();

  setInterval(() => { evaluateCoachMessages(); }, 60 * 60 * 1000);
  setInterval(() => {
    const extremeTasks = tasks.filter(t => {
      if (t.completed) return false;
      const days = getDaysUntilDeadline(t.deadline);
      return days < 0 && Math.abs(days) >= 3;
    });

    extremeTasks.forEach(task => {
      const level = 'extreme';
      const message = getRandomPhrase(level, task.title);

      if (getMessageCountToday(task.id) < 20) {
        sendCoachPanelMessage(task, level, message);
        if (Math.random() > 0.7) showCoachPopup(task, level, message);
      }
    });
  }, 15 * 60 * 1000);

</script>

<!-- ‚úÖ FIREBASE AUTH GATE + REAL LOGOUT + FIRESTORE PERSISTENCE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    updateDoc,
    getDocs,
    query,
    orderBy,
    limit,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBqQF1Tijz_wctD0Z7kSCB80DeiWY1ZPyw",
    authDomain: "metrix-hardline.firebaseapp.com",
    projectId: "metrix-hardline",
    storageBucket: "metrix-hardline.firebasestorage.app",
    messagingSenderId: "899994703104",
    appId: "1:899994703104:web:2979fe39d1c3c169ee4fe5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --------- Task persistence helpers ---------
  async function loadTasks(uid) {
    const snap = await getDocs(collection(db, "users", uid, "tasks"));
    const loaded = [];
    snap.forEach(d => loaded.push(d.data()));

    // Replace in-memory tasks array (used by your existing UI)
    window.tasks.length = 0;
    loaded.forEach(t => window.tasks.push(t));
  }

  async function saveTask(uid, task) {
    // Use task.id as Firestore doc id for stable updates
    await setDoc(doc(db, "users", uid, "tasks", task.id), task, { merge: true });
  }

  async function setTaskCompleted(uid, taskId, completed) {
    await updateDoc(doc(db, "users", uid, "tasks", taskId), { completed });
  }

  // Expose tiny hooks to your existing script (no UI changes)
  window._saveTask = (task) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return saveTask(uid, task);
  };
  window._setTaskCompleted = (taskId, completed) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    return setTaskCompleted(uid, taskId, completed);
  };

  // --------- Coach message persistence helpers ---------
  async function loadCoachMessages(uid) {
    const q = query(
      collection(db, "users", uid, "coachMessages"),
      orderBy("timestamp"),
      limit(200)
    );
    const snap = await getDocs(q);
    const msgs = [];
    snap.forEach(d => msgs.push(d.data()));

    // Keep your existing logic working (it reads from localStorage)
    localStorage.setItem("metrix_coach_messages", JSON.stringify(msgs));

    // Render panel messages into existing UI (no UI changes)
    const container = document.getElementById("coachMessages");
    if (container) {
      container.innerHTML = "";
      msgs.forEach(m => {
        if (m.type !== "panel") return;
        const messageEl = document.createElement('div');
        messageEl.className = `coach-message level-${m.level}`;
        messageEl.innerHTML = `
          <div class="coach-message-header">
            <span>üéØ Coach</span>
            <span>${new Date(m.timestamp || Date.now()).toLocaleTimeString()}</span>
          </div>
          <div class="coach-message-body">${m.message}</div>
          <div class="coach-message-task">Re: ${m.taskTitle || ""}</div>
        `;
        container.appendChild(messageEl);
      });
      container.scrollTop = container.scrollHeight;
    }
  }

  async function persistCoachMessage(uid, msg) {
    await addDoc(collection(db, "users", uid, "coachMessages"), {
      ...msg,
      createdAt: serverTimestamp()
    });
  }

  window._persistCoachMessage = (msg) => {
    const uid = localStorage.getItem("uid");
    if (!uid) return;
    // fire-and-forget to avoid changing UX
    persistCoachMessage(uid, msg).catch(() => {});
  };

  // Expose logout globally so your existing menu button can call it
  window.logout = function () {
    signOut(auth).finally(() => {
      localStorage.removeItem("uid");
      window.location.href = "login.html";
    });
  };

  // Gate access: if not logged in, redirect to login.html
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    localStorage.setItem("uid", user.uid);

    // Show real logged-in email in the menu
    const emailEl = document.getElementById("menuEmail");
    if (emailEl) emailEl.textContent = user.email || "";

    // ‚úÖ Load persisted user data
    await loadTasks(user.uid);
    await loadCoachMessages(user.uid);

    // Re-render using your existing functions (no UI changes)
    if (typeof window.renderCalendar === "function") window.renderCalendar();
    if (typeof window.updateStats === "function") window.updateStats();

    // ‚úÖ NEW: run overdue prompt check after Firestore loads
    if (window.checkOverdueCompletionPrompts) window.checkOverdueCompletionPrompts();
  });
</script>

</body>
</html>
